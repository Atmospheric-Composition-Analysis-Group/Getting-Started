Data Storage
============

This is a rolling copy of the group's storage policy. 

Our group's allocation is 1.5 PB of Active
plus 505 TB of Archive. Our Active allocation is at :code:`/storage1/fs1/rvmartin/Active` (1 PB) and :code:`/storage1/fs1/rvmartin2/Active` (0.5 PB). 

Our Archive
allocation is at :code:`/storage1/fs1/rvmartin/Archive` (1.5 PB) and :code:`/storage1/fs1/rvmartin2/Archive` (5 TB). 

The Active allocation is where you should put 
data that you are currently working with. Once a project finishes you should move its data to 
Archive. 

Data Transfer between Active and Archive
-----------------------------------------

* `Globus <https://app.globus.org/>`_ (Recommended): The Globus endpoints for Storage1 are named :literal:`RIS Storage1`, :literal:`Wash U RIS storage1 dtn1` and :literal:`Wash U RIS storage1 dtn2`.

   * File status can be checked by: :code:`mmlsattr -L $FILE_PATH`, where :code:`Misc attributes` of :code:`ARCHIVE OFFLINE` means the file has been moved from :code:`cache` to :code:`tape`, and :code:`ARCHIVE` means the file is on :code:`cache`.
   * Globus transfers files on :code:`cache` seamlessly with fast speed, while experiencing unpredictable delays and probably denoting :code:`endpoint error`, ranging from several minutes to hours, for files on :code:`tape`.
   * Manually bringing files from :code:`tape` to :code:`cache` in advance, called rehydration, can speed up Globus transferring a lot, which can be achived by :code:`file` command. Specific usage is running :code:`file $FILE_PATH` from a home node (compute1-client-\*). Wildcards (\*) or rehydrating all files in a directory is also supported for :code:`file` command.
* The :code:`safe-transfer` script in the :code:`/Shared` directory.

Checking usage
--------------

Monthly usage reports for rvmartin allocation are generated in :code:`/storage1/fs1/rvmartin/Active/Shared/StorageReports`. Run the
:code:`./view_most_recent_usage_report` command:

.. code-block:: console
   
   $ cd /storage1/fs1/rvmartin/Active/Shared/StorageReports
   $ ./view_most_recent_usage_report

Monthly usage reports for rvmartin2 allocation are generated in :code:`/storage1/fs1/rvmartin2/Active/Shared/StorageReports`. Run the
:code:`./view_most_recent_usage_report` command:

.. code-block:: console
   
   $ cd /storage1/fs1/rvmartin2/Active/Shared/StorageReports
   $ ./view_most_recent_usage_report
   
A combined usage report for both rvmartin and rvmartin2 allocation is generated by running the :code:`./view_both_allocations_usage_report` 
command:

.. code-block:: console
   
   $ cd /storage1/fs1/rvmartin/Active/Shared/StorageReports
   $ ./view_both_allocations_usage_report

The controls are below.

.. code-block:: none
   
   q - quit
   j - down
   k - up
   / - search for text
      n - next match
      N - previous match

To view the total Active storage space left on rvmartin allocation:

.. code-block:: console
   
   $ mmlsquota --block-size auto -j rvmartin_active rdcw-fs1
   
To view the total Active storage space left on rvmartin2 allocation:

.. code-block:: console
   
   $ mmlsquota --block-size auto -j rvmartin2_active rdcw-fs2

Policy
------

This policy is not intended to impose any restrictions on your usage of Compute1 or Storage1. It's
moreso intended to facilitate the data lifecycle of the group.

1. The Archive directory should have the same structure as the Active directory. If you are
   archiving :code:`rvmartin/Active/lbindle/sgv` it should go in :code:`rvmartin/Archive/lbindle/sgv`.
2. If you are done with a directory, and it can be archived, move it to Archive. If at any point you
   need to bring it back, it's easy to do with Globus (mind you it might take several days if it's
   large).
3. Before you leave the group, archive your entire project directory.
4. Every 6 months to a year, go through your directories and archive anything that you can.

